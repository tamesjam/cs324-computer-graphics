<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	 <link rel="stylesheet" type="text/css" href="styles.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CS324 Coursework</title>
</head>
<body>
  <div id="blocker">
    <div id="click">
      <p style="font-size:75px">
        The AMG Experience
      </p>
      <div id="play">
        <p>PLAY</p>
      </div>
      <div id="how_play">
        <p>How To Play</p>
      </div>
      <div id="controls">
        <p>Controls</p>
      </div>
      <div id="credits">
        <p>Credits</p>
      </div>
    </div>
    <div id="play_content">
      <p style="font-size:40px">
        Would you like a practice lap before the race starts?
      </p>
      <p style="font-size:20px">
       Get to grips with the layout of our customised racetrack!
      </p>
      <div id="yes_no_layout">
        <div id="yes">
          <p>Yes please!</p>
        </div>
        <div id="no">
          <p>No, I know the track already!</p>
        </div>
      </div>
      <div id="back">Press [ESC] to go back</div>
    </div>
    <div id="how_play_content">
      <p style="font-size:40px">
        How To Play
      </p>
      <p style="font-size:20px">
        Race this authentic Majestic-Benz SLS AMG Roadster around our customised track to achieve the fastest time possible! <br>
        Complete each challenge where each level increases in difficulty! <br>
        Do you have what it takes to be the best racing driver?
      </p>
      <div id="back">Press [ESC] to go back</div>
    </div>
    <div id="controls_content">
      <p style="font-size:40px">
        Controls
      </p>
      <p style="font-size:20px">
        <u>Car Controls</u><br>
        Accelerate - [W] <br>
        Brake/Reverse - [S] <br>
        Steer Left - [A] <br>
        Steer Right - [D] <br>
        <br>

        <u>Camera Controls</u><br>
        Dynamic View - [1]<br>
        Third Person View - [2]<br>
        Top Down View - [3]
      </p>
      <div id="back">Press [ESC] to go back</div>
    </div>
    <div id="credits_content">
      <p style="font-size:40px">
        Credits
      </p>
      <p style="font-size:20px">
        A video game inspired by popular racing video game franchise, Need For Speed (NFS). <br><br>

        <u>Game Design</u><br>
        Lead Developer - James Tam<br>
        Student ID - 1913904<br>
        University Of Warwick<br><br>

        <u>Game Models</u><br>
        "Majestic-Benz" car model made by myself<br>
        All other models imported online<br>

        <u>Game Music</u><br>
        Theme Song: <br>
        Euro Truck Simulator 2 (#5 Menu 2)<br>
        SCS Software<br>
        http://www.mediafire.com/file/2niwc1ttda3rhad/ETS2-MusicPlaylist.rar/file<br><br>

        Sound FX: <br>
        https://www.myinstants.com/instant/ding-sound-effect/<br>
        https://www.myinstants.com/instant/dc-fail/


      </p>
      <div id="back">Press [ESC] to go back</div>
    </div>
  </div>

  <div id="outsideMap">
    Race track out of bounds!
  </div>

  <div id="leaderboard">
    <div id="leaderboard_title">
      Lap Times
    </div>
    <div id="race_started">
      Head to the start line to begin racing!
    </div>
    <div id="lap_times">
    </div>
    <div id="challenges">
      Challenges: <br>
      <div id="level_one">Easy level - <br> Complete in under 35 seconds!</div>
      <div id="level_two">Medium level - <br> Complete in under 30 seconds!</div>
      <div id="level_three">Hardcore level - <br> Complete in under 28 seconds!</div>
    </div>
  </div>

  <div id="dashboard">
    <div id="speedometer"></div>
    <div id="bottom_dashboard">
      <div id="times"></div>
      <div id="view">Dynamic View</div>
    </div>
  </div>

	<script src="./node_modules/three/build/three.min.js"></script>
  <script src="./node_modules/three/examples/js/loaders/GLTFLoader.js"></script>
  <script src="./node_modules/cannon/build/cannon.js"></script>
  <script src="./node_modules/three/examples/js/misc/Gyroscope.js"></script>
  <script src="./CannonDebugRenderer.js"></script>
    <script type="module">
      import { OrbitControls } from "./node_modules/three/examples/js/controls/OrbitControls.js";

      var camera, dynamic_view, top_view, fixed_view; 
      var renderer;
      var scene, plane, model_light;
      var skybox, skyboxArray = [];
      var sunlight;
      var controls, controlKeys = {};

      // audio
      var game_music, audioContext, sound_success, sound_fail;

      // blender models/animations
      var loader; 
      var car_model, tree_model, tyre_wall, finish_line;
      var mixer, front_anim, back_anim;

      // variables for controlling game logic
      var main_menu = true, daytime = false, fog = false, race_started = false;

      // timing for racing lap times
      var clock = new THREE.Clock();
      var elapsed = 0;

      // camera rotation during main menu
      var rotation = 0;

      // car's initial position
      var x_car = -9500;
      var y_car = 0;
      var z_car = -6900;

      // Fixed birds-eye view look at position
      const fixed_x = 0;
      const fixed_y = 8000;
      const fixed_z = 13000;

      // Speed (rate of increase to car position)
      var increment = 0;
      var steering = 0;

      // Road resistance, decrements 'increment' variable
      const FORWARD_RESISTANCE = 0.25;
      const BACKWARDS_RESISTANCE = 0.2;

      // TESTING THIRD PERSON VIEW
      var mesh, goal, follow;

      var time = 0;
      var newPosition = new THREE.Vector3();
      var matrix = new THREE.Matrix4();

      var temp = new THREE.Vector3;
      var dir = new THREE.Vector3;
      var a = new THREE.Vector3;
      var b = new THREE.Vector3;
      var coronaSafetyDistance = 3000;
      var velocity = 0.0;
      var speed = 0.0;

      var speedometer, dashboard, times, view, leaderboard, leaderboard_title, lap_times, lap_number = 0, race_started_text, level_one, level_two, level_three, outsideMap1;

      var sight_lap;

      // Cannon.js variables
      var cannon_world;
      var cannon_plane;
      var cannonDebug;

      var carMesh;
      var carBody;

      var barrierMesh = [];
      var barrierBody = [];
      var barrierArray = [];

      var tyreMesh = [];
      var tyreBody = [];
      var tyreArray = [];

      var l1 = true, l2 = true, l3 = true;

      init();
      animate();

      function init() {
        var day_or_night = Math.floor(Math.random() * 2);
        daytime = (day_or_night == 0) ? true : false; // set to day time if random variable is 0, else night time

        initCameras();
        initRenderer();
        initControls();
        initScenePlane();
        initSkybox();
        initLights();
        initSounds();
        initHTMLElements();

        // physics engine - cannon.js
        initCannonWorld();
        initModels(); // load blender model and initialise cannonjs on them
        initCannonDebugger();

        // Add the objects to the scene
        scene.add(skybox);
        scene.add(plane);
        scene.add(model_light);
        scene.add(finish_line);
        scene.add(game_music);
        scene.add(sound_success);
        scene.add(sound_fail);

        // Add/remove sunlight source depending on if day/night time
        if(daytime) {
          scene.add(sunlight);
        }

        animate();
      }

      function updatePhysics() {
        cannon_world.step(1.0/60.0);

        if (controlKeys.a && increment > 0.1) {
          carMesh.rotation.y += steering;
          carBody.quaternion.y += steering;
          // carBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), steering);
        }else if(controlKeys.d && increment > 0.1){
          carMesh.rotation.y += -steering;
          carBody.quaternion.y += -steering;
          // carBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), -steering);
        }else if (controlKeys.a && increment < -0.1) {
          carMesh.rotation.y += -steering;
          carBody.quaternion.y += steering;
          // carBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), -steering);
        }else if(controlKeys.d && increment < -0.1){
          carMesh.rotation.y += steering;
          carBody.quaternion.y += steering;
          // carBody.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), steering);
        }

        carMesh.position.set(
          car_model.position.x,
          car_model.position.y,
          car_model.position.z
        )


        carBody.position.set(
          carMesh.position.x,
          carMesh.position.y,
          carMesh.position.z
        )


        carBody.quaternion.set(
          carMesh.quaternion.x,
          carMesh.quaternion.y,
          carMesh.quaternion.z,
          carMesh.quaternion.w
        )

        for(var i = 0; i < barrierMesh.length; i++) {
          barrierArray[i].position.set(
            barrierBody[i].position.x,
            barrierBody[i].position.y,
            barrierBody[i].position.z
          )

          barrierArray[i].quaternion.set(
            barrierBody[i].quaternion.x,
            barrierBody[i].quaternion.y,
            barrierBody[i].quaternion.z,
            barrierBody[i].quaternion.w,
          )

          barrierMesh[i].position.set(
            barrierBody[i].position.x,
            barrierBody[i].position.y,
            barrierBody[i].position.z
          )
        }

        for(var i = 0; i < tyreMesh.length; i++) {
          tyreArray[i].position.set(
            tyreBody[i].position.x,
            tyreBody[i].position.y - 200,
            tyreBody[i].position.z
          )

          tyreArray[i].quaternion.set(
            tyreBody[i].quaternion.x,
            tyreBody[i].quaternion.y,
            tyreBody[i].quaternion.z,
            tyreBody[i].quaternion.w,
          )

          tyreMesh[i].position.set(
            tyreBody[i].position.x,
            tyreBody[i].position.y,
            tyreBody[i].position.z
          )

          tyreMesh[i].quaternion.set(
            tyreBody[i].quaternion.x,
            tyreBody[i].quaternion.y,
            tyreBody[i].quaternion.z,
            tyreBody[i].quaternion.w,
          )
        }
      }

      function animate() {
        requestAnimationFrame(animate);
        updatePhysics();

        // console.log(bbox.min);

        // For model animation purposes
        var delta = clock.getDelta();
        if(mixer !== undefined) {
          mixer.update(delta);
        };

        // Dashboard speedometer display - change colour when top speed reached
        speedometer.innerHTML = (Math.round(increment)) + " mph";
        if(increment == 80) {
          speedometer.style.color = 'red';
        }else {
          speedometer.style.color = 'white';
        }

        // Dashboard timing display for lap times
        if(!race_started) {
          times.style.color = 'red';
          times.innerHTML = "Head to the start line to begin racing!"
        }else if(race_started){
          times.style.color = 'white';
          if(sight_lap) {
            times.innerHTML = "(Practice) Lap Time: " + clock.elapsedTime.toFixed(2) + " secs";
          }else {
            times.innerHTML = "Lap Time: " + clock.elapsedTime.toFixed(2) + " secs";
          }
        }

        if(car_model !== undefined) {
          if(insideFinishLine(car_model.position)) {
            if(!race_started) {
              race_started = true;
              lap_number++;
              clock.start();
              fadeIn();

              if(sight_lap) {
                race_started_text.innerHTML = "FIRST PRACTICE LAP"
                race_started_text.style.color = "yellow";
              }else {
                race_started_text.innerHTML = "RACE STARTED"
                race_started_text.style.color = "green";
              }
            }else if(clock.elapsedTime > 2){
              race_started = false;
              clock.stop();

              if(!sight_lap) {
                if(clock.elapsedTime < 35 && l1) {
                  level_one.style.color = 'green';
                  level_two.style.display = 'block';
                  l1 = false;
                  sound_success.play();
                  scene.fog = new THREE.Fog( 0xffffff, 100, 10000 );

                }else if(clock.elapsedTime < 30 && l2) {
                  level_two.style.color = 'green';
                  level_three.style.display = 'block';
                  l2 = false;
                  sound_success.play();
                  scene.fog = new THREE.Fog( 0xffffff, 3, 5500);

                }else if(clock.elapsedTime < 28 && l3) {
                  level_three.style.color = 'green';
                  l3 = false;
                  sound_success.play();

                }else if(!l1 && !l2 && !l3){
                  sound_success.play();
                }else {
                  sound_fail.play();
                }

                if(!l1 && !l2 && !l3){
                  scene.fog = new THREE.Fog(0xffffff, 0.1, 0);
                }
              }

                var div = document.createElement('div');
                if(sight_lap) {
                  div.innerHTML += "Practice "
                }
                div.innerHTML += "Lap (" + lap_number + ")    " + clock.elapsedTime.toFixed(4) + " s";
                lap_times.appendChild(div);

              sight_lap = false;
            }
          }
        }

        // Check and display warning if vehicle is out of bounds of plane
        if(car_model !== undefined) {
          if(!insideMap(car_model.position)) {
            outsideMap1.style.visibility = 'visible';
          }else {
            outsideMap1.style.visibility = 'hidden';
          }
        }

        // console.log(main_menu);

        if(main_menu) { // Display rotational view whilst in main menu
            rotation += 0.0075;
            camera.position.x = Math.sin(rotation) * 9000;
            camera.position.y = 5000;
            camera.position.z = Math.cos(rotation) * 9000;
            camera.lookAt(new THREE.Vector3(0 , 100, 0));

            // Remove dashboard/leaderboard from user view
            dashboard.style.display = 'none';
            leaderboard.style.display = 'none';
        }else {
            dashboard.style.display = 'block';
            leaderboard.style.display = 'block';

            if(camera == dynamic_view) { // Third person view
              controls.enabled = true;
              a.lerp(car_model.position, 0.8);
              b.copy(goal.position);

              dir.copy(a).sub(b).normalize();
              const dis = a.distanceTo( b ) - coronaSafetyDistance;
              goal.position.addScaledVector( dir, dis );
              goal.position.lerp(temp, 0.02);
              temp.setFromMatrixPosition(follow.matrixWorld);

              camera.lookAt(car_model.position.x, car_model.position.y, car_model.position.z);
            }else if(camera == fixed_view) {
              controls.enabled = false;
              var relativeCameraOffset = new THREE.Vector3(20, 8, 0);
              var cameraOffset = car_model.localToWorld(relativeCameraOffset);

              camera.position.copy(cameraOffset);
              camera.lookAt(car_model.position.x, car_model.position.y + 200, car_model.position.z);
              // console.log(car_model.position);
            }else if(camera == top_view) { // Free view
              controls.enabled = false;
              camera.position.set(fixed_x, fixed_y, fixed_z);
              camera.lookAt(50,0,-55);
            }

            if(increment != 0) {
              front_anim.play();
              back_anim.play();
            }else {
              front_anim.stop();
              back_anim.stop();
            }

            if(controlKeys["w"] || (controlKeys["w"] && controlKeys["a"]) || (controlKeys["w"] && controlKeys["d"])) {
              if(increment < 30) { // From stationary
                increment += 0.4;
              }else {
                increment += 0.6;
              }
            }

            // console.log(increment)
            if(!controlKeys["w"] && increment > 0.2) {
              increment -= FORWARD_RESISTANCE;
            }else if(!controlKeys["s"] && increment < 0) {
              increment += BACKWARDS_RESISTANCE;
            }else if(increment >= -0.2 && increment <= 0.2){ // Standstill
              increment = 0;
            }

            velocity += (increment - velocity) * 0.3;
            car_model.translateX(-velocity);

            // Steering for the car - only when moving and in correct direction when going forwards/backwards
            if (controlKeys.a && increment > 0.1) {
              car_model.rotateY(steering);
            }else if(controlKeys.d && increment > 0.1){
              car_model.rotateY(-steering);
            }else if (controlKeys.a && increment < -0.1) {
              car_model.rotateY(-steering);
            }else if(controlKeys.d && increment < -0.1){
              car_model.rotateY(steering);
            }

            if(controlKeys["s"] || (controlKeys["s"] && controlKeys["a"]) || (controlKeys["s"] && controlKeys["d"])) {
              if(increment == 0) { // From stationary
                increment -= 0.7;
              }else {
                increment -= 0.55;
              }
            }

            if(controlKeys["a"] || controlKeys["d"]) {
              if(increment < 18) {
                steering = 0.012;
              }else {
                steering += 0.0025;

              }
            }

            if (increment > 80) increment = 80;
            if (increment < -40) increment = -40;

            if(steering > 0.035) steering = 0.037;
        }

        // boxBody.position.set(car_model.position);
        // console.log(boxBody.position);

        render();
      }

      function render() {
        controls.update();
        if(cannonDebug !== undefined) {
          // cannonDebug.update(); // Cannon.js debugging purposes
        }
        renderer.render(scene,camera);
      }

      function keydown(e) {
        var key = e.code.replace('Key', '').toLowerCase();
        if(!main_menu) {

          // Keydown events for WASD keys
          if(controlKeys[key] !== undefined) {
            controlKeys[key] = true; // Set whichever key pressed to TRUE
          }

          // Switching between camera views
          if(key == "digit1") {
            camera = dynamic_view;
            view.innerHTML = "Dynamic View"
          }else if(key == "digit2") {
            camera = fixed_view;
            view.innerHTML = "Third Person View"
          }else if(key == "digit3") {
            camera = top_view;
            view.innerHTML = "Birds-eye View"
          }
        }else {
          if(key == "escape") {
            if(play_content.style.display == "flex") {
              play_content.style.display = "none";
              click.style.display = "flex"
            }else if(how_play_content.style.display == "flex") {
              how_play_content.style.display = "none";
              click.style.display = "flex"
            }else if(controls_content.style.display == "flex") {
              controls_content.style.display = "none";
              click.style.display = "flex"
            }else if(credits_content.style.display == "flex") {
              credits_content.style.display = "none";
              click.style.display = "flex"
            }
          }
        }
      }

      function keyup(e) {
        var key = e.code.replace('Key', '').toLowerCase();
        if(controlKeys[key] !== undefined ){
            controlKeys[key] = false;

            // Releasing a/d keys restores initial steering position
            if(!controlKeys["a"] || !controlKeys["d"]) {
              steering = 0;
            }
        }
      }

      function fadeIn(){
        leaderboard.style.opacity = 0.85;
        leaderboard.style.transition = "linear 0.35s";
      }

      function insideMap(car_position) {
        return (
          car_position.x > -13711 && car_position.x < 14000 && 
          car_position.z > -9630 && car_position.z < 9500
        )
      }

      function insideFinishLine(car_position) {
        if(car_model.position.x >= -2700 && car_model.position.x <= -2500 && car_model.position.z > -9500 && car_model.position.z < -6000) {
          return true;
        }else {
          return false;
        }
      }

      function initCameras() {
        // Set initial camera position in world coordinates
        var x_camera = 900;
        var y_camera = 600;
        var z_camera = 0;
        var camera_vector = new THREE.Vector3(x_camera, y_camera, z_camera);

        // Set inital look-at position vector
        var x_look = -600;
        var y_look = 0;
        var z_look = -80;
        var look_vector = new THREE.Vector3(x_look, y_look, z_look);

        // Set the cameras up - third-person and top-down view
        dynamic_view = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100000);
        top_view = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100000);
        fixed_view = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100000);

        camera = dynamic_view; // Initial camera set up is third-person view
      }

      function initRenderer() {
        // Set the WebGL Renderer
        renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth,window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio * 0.7);
        document.body.appendChild(renderer.domElement);

        renderer.outputEncoding = THREE.sRGBEncoding;
        renderer.shadowMap.enabled = false;
        renderer.shadowMapSoft = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        document.documentElement.style.overflow = 'hidden';
        document.body.sroll = "none";
      }

      function initControls() {
        // Initialise car movement key parameters
        controlKeys = {
          w: false,
          s: false,
          d: false,
          a: false
        };

        // Set the controls, Orbit for zooming/rotating/panning
        controls = new OrbitControls(camera, renderer.domElement);

        controls.rotateSpeed *= 0.3;
        controls.minDistance = 300;
        controls.maxDistance = 8000;
        controls.zoomSpeed = 7;
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;

        controls.maxPolarAngle = Math.PI * 0.48;

        controls.mouseButtons = {
          LEFT: THREE.MOUSE.ROTATE,
          MIDDLE: THREE.MOUSE.DOLLY,
        }
      }

      function initScenePlane() {
        // Setting the scene
        scene = new THREE.Scene();

        // Setting the plane's size/texture/properties
        var texture = new THREE.TextureLoader().load('assets/images/racetrack.jpg');
        var geometry = new THREE.PlaneGeometry(28000, 20000, 1, 1);
        var material = new THREE.MeshPhongMaterial({ color: 0xffffff, map: texture});
        
        plane = new THREE.Mesh(geometry, material);
        plane.material.map.wrapS = THREE.RepeatWrapping;
        plane.material.map.wrapT = THREE.RepeatWrapping;
        plane.material.map.encoding = THREE.sRGBEncoding;
        plane.castShadow = true;
        plane.receiveShadow = true;
        plane.rotation.x = -Math.PI / 2;

        // Adding light to the car model
        model_light = new THREE.HemisphereLight(0xffffff, 0x000000, 0.15);
      }

      function initSkybox() {
        // Set the skybox background setting - load 6 faces of box
        const texture_ft = new THREE.TextureLoader().load( './assets/images/humble_ft.jpg');
        const texture_bk = new THREE.TextureLoader().load( './assets/images/humble_bk.jpg');
        const texture_up = new THREE.TextureLoader().load( './assets/images/humble_up.jpg');
        const texture_dn = new THREE.TextureLoader().load( './assets/images/humble_dn.jpg');
        const texture_rt = new THREE.TextureLoader().load( './assets/images/humble_rt.jpg');
        const texture_lf = new THREE.TextureLoader().load( './assets/images/humble_lf.jpg');

        var colorSkybox = (daytime == true) ? 0xffffff : 0x363636;
          
        skyboxArray.push(new THREE.MeshBasicMaterial( { color: colorSkybox, map: texture_ft }));
        skyboxArray.push(new THREE.MeshBasicMaterial( { color: colorSkybox, map: texture_bk }));
        skyboxArray.push(new THREE.MeshBasicMaterial( { color: colorSkybox, map: texture_up }));
        skyboxArray.push(new THREE.MeshBasicMaterial( { color: colorSkybox, map: texture_dn }));
        skyboxArray.push(new THREE.MeshBasicMaterial( { color: colorSkybox, map: texture_rt }));
        skyboxArray.push(new THREE.MeshBasicMaterial( { color: colorSkybox, map: texture_lf }));
   
        for (let i = 0; i < 6; i++) {
           skyboxArray[i].side = THREE.BackSide;
        }

        const skyboxGeo = new THREE.BoxGeometry( 43000, 43000, 43000);
        skybox = new THREE.Mesh( skyboxGeo, skyboxArray );
      }

      function initLights() {
        // Set the primary light source
        sunlight = new THREE.DirectionalLight( 0xffffff, 1);
        sunlight.position.set( 15000, 10000, 6000 );
        sunlight.castShadow = true;
        sunlight.shadow.mapSize.width = 2048;
        sunlight.shadow.mapSize.height = 1024;
        sunlight.shadow.camera.near = 0.1;2
        sunlight.shadow.camera.far = 35000;
        sunlight.shadow.camera.fov = 60;
        sunlight.shadow.camera.left = -14000; // fit light to plane
        sunlight.shadow.camera.right = 14000;
        sunlight.shadow.camera.top = 8000;
        sunlight.shadow.camera.bottom = -9000;
        sunlight.shadow.radius = 6;
      }

      function initSounds() {
        getAudioContext();

        const audioListener = new THREE.AudioListener();
        const audioLoader = new THREE.AudioLoader();

        game_music = new THREE.Audio(audioListener);
        sound_success = new THREE.Audio(audioListener);
        sound_fail = new THREE.Audio(audioListener);

        audioLoader.load('./assets/sounds/ets2.mp3', function(buffer) {
          game_music.setBuffer(buffer);
          game_music.setLoop(true);
          game_music.setVolume(0.2);
          game_music.play();
        },  function ( xhr ) {
            // console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
          }, function ( err ) {
            console.log('An error occured');
          }
        );

        audioLoader.load('./assets/sounds/sound_lap.mp3', function(buffer) {
          sound_success.setBuffer(buffer);
          sound_success.setLoop(false);
          sound_success.setVolume(0.5);
        },  function ( xhr ) {
            // console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
          }, function ( err ) {
            console.log('An error occured');
          }
        );

        audioLoader.load('./assets/sounds/fail.mp3', function(buffer) {
          sound_fail.setBuffer(buffer);
          sound_fail.setLoop(false);
          sound_fail.setVolume(0.5);
        },  function ( xhr ) {
            // console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
          }, function ( err ) {
            console.log('An error occured');
          }
        );
      }

      function initModels() {
        // Loading models
        loader = new THREE.GLTFLoader();

        loader.load('./assets/blender/car_blend_final.glb', function (gltf) {
          car_model = gltf.scene;
          car_model.scale.set(75, 75, 75);
          car_model.traverse(c => {
            c.castShadow = true;
          });

          // Set the car's intitial position
          car_model.position.x = x_car;
          car_model.position.y = y_car;
          car_model.position.z = z_car;
          car_model.rotateY(THREE.MathUtils.degToRad(180));

          car_model.animations = gltf.animations;

          mixer = new THREE.AnimationMixer(car_model);
          front_anim = mixer.clipAction(gltf.animations[1]);
          back_anim = mixer.clipAction(gltf.animations[2]);

          goal = new THREE.Object3D; // Used in camera following
          follow = new THREE.Object3D;
          follow.position.x = -50;
          car_model.add(follow);
          goal.add(camera);
      
          initCannonCar(car_model);

          scene.add(car_model);
        });

        loader.load('./assets/blender/tree.glb', function (gltf) {
          tree_model = gltf.scene;
          tree_model.scale.set(800, 800, 800);
          tree_model.traverse(c => {
            c.castShadow = true;
          });

          for(var i = 3000; i <= 27000; i+= 2000) {
            var duplicate0 = tree_model.clone();
            var duplicate2 = tree_model.clone();

            duplicate0.position.set(-14000 + i, -100, -10500); // top

            duplicate2.position.set(-14000 + i, -100, 8600); // bottom
            scene.add(duplicate0);
            scene.add(duplicate2);
          }

          for(var i = 3000; i <= 19000; i+= 2000) {
            var duplicate1 = tree_model.clone(); // left
            var duplicate3 = tree_model.clone(); // right

            duplicate1.rotateY(THREE.MathUtils.degToRad(90)); // left
            duplicate1.position.set(-14500, -100, -12000 + i);

            duplicate3.rotateY(THREE.MathUtils.degToRad(90)); // left
            duplicate3.position.set(12500, -100, -12000 + i);
            scene.add(duplicate1);
            scene.add(duplicate3);
          }
        });

        loader.load('./assets/blender/tyre_wall.glb', function (gltf) {
          tyre_wall = gltf.scene;
          tyre_wall.scale.set(60, 60, 60);
          tyre_wall.traverse(c => {
            c.castShadow = true;
          });

          for(var i = 0; i <= 31; i++) {
            var duplicate0 = tyre_wall.clone();
            scene.add(duplicate0);
            tyreArray.push(duplicate0);
          }

          initTyres();
        });

        loader.load('./assets/blender/barrier.glb', function (gltf) {
            var barrier = gltf.scene;
            barrier.scale.set(2600, 340, 350);
            barrier.traverse(c => {
              c.castShadow = true;
              c.receiveShadow = true;
            });
            // ---------------- Centre map barrier 1 ------------------
            barrierArray.push(barrier);
            scene.add(barrier);

            // ---------------- Centre map barrier 2 ----------------
            var duplicate = barrier.clone();
            duplicate.scale.set(1800, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Centre map barrier 3 ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(2500, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Bottom right barrier ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(1450, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Bottom left 1 barrier ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(1900, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Bottom left 2 barrier ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(1300, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Top left barrier ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(3000, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Centre right 1 barrier ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(2100, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            // ---------------- Centre right 2 barrier ----------------
            duplicate = barrier.clone();
            duplicate.scale.set(1700, 340, 350);
            barrierArray.push(duplicate);
            scene.add(duplicate);

            initBarrier();
        });

        loader.load('./assets/blender/street_lamp.glb', function (gltf) {
          var street_lamp = gltf.scene;
          street_lamp.scale.set(85, 115, 85);
          street_lamp.traverse(c => {
            c.castShadow = true;
            c.receiveShadow = true;
          });

          for(var i = 0; i <= 15000; i+= 3000) {
            var duplicate0 = street_lamp.clone();
            duplicate0.position.set(-8500 + i, 0, -5700);
            duplicate0.rotateY(THREE.MathUtils.degToRad(90));

            var duplicate1 = street_lamp.clone();
            duplicate1.position.set(-8500 + i, 0, -5700);
            duplicate1.rotateY(THREE.MathUtils.degToRad(270));

            var spotlight = new THREE.PointLight(0xffffff, 0.2);
            var spotlight1 = new THREE.PointLight(0xffffff, 0.2);

            spotlight.decay = 2;
            spotlight.distance = 10000;
            spotlight1.decay = 2;
            spotlight1.distance = 10000;


            spotlight.position.set( -8500 + i, 1000, -6300 );
            spotlight1.position.set( -8500 + i, 1000, -5100 );
            
            scene.add(duplicate0);
            scene.add(duplicate1);

            if(!daytime) {
              scene.add(spotlight); // Add a secondary light source when night
              scene.add(spotlight1);
            }
          }          
        });

        // Adding a start/finish line for timing
        const chequered_texture = new THREE.TextureLoader().load(
          './assets/images/chequered.jpg'
        );
        const geo = new THREE.BoxGeometry( 500, 11, 2800 );
        const mat = new THREE.MeshBasicMaterial({ map: chequered_texture });
        finish_line = new THREE.Mesh(geo, mat);
        finish_line.position.set(-2000, 0, -7400);
      }

      function initHTMLElements() {
        // Set the main menu - pause game/read instructions
        const blocker = document.getElementById('blocker');
        const click = document.getElementById('click');

        const play = document.getElementById('play');
        const how_play = document.getElementById('how_play');
        const controls = document.getElementById('controls');
        const credits = document.getElementById('credits');

        const play_content = document.getElementById('play_content');
        const yes = document.getElementById('yes');
        const no = document.getElementById('no');
        const how_play_content = document.getElementById('how_play_content');
        const controls_content = document.getElementById('controls_content');
        const credits_content = document.getElementById('credits_content');

        speedometer = document.getElementById('speedometer');
        dashboard = document.getElementById('dashboard');
        times = document.getElementById('times');
        view = document.getElementById('view');
        lap_times = document.getElementById('lap_times');
        leaderboard = document.getElementById('leaderboard');
        leaderboard_title = document.getElementById('leaderboard_title')

        race_started_text = document.getElementById('race_started');
        level_one = document.getElementById('level_one');
        level_two = document.getElementById('level_two');
        level_three = document.getElementById('level_three');
        outsideMap1 = document.getElementById('outsideMap');

        // Event listeners for keyboard/resize events
        document.addEventListener("keydown", keydown, false);
        document.addEventListener("keyup", keyup, false);
        window.addEventListener("resize", onWindowResize);

        play.addEventListener('click', function() {
          click.style.display = 'none';
          play_content.style.display = 'flex';
        });

        yes.addEventListener('click', function() {
          sight_lap = true;
          blocker.style.display = 'none';
          main_menu = false;
        });

        no.addEventListener('click', function() {
          sight_lap = false;
          blocker.style.display = 'none';
          main_menu = false;
        });

        how_play.addEventListener('click', function() {
          click.style.display = 'none';
          how_play_content.style.display = 'flex';
        });

        controls.addEventListener('click', function() {
          click.style.display = 'none';
          controls_content.style.display = 'flex';
        });

        credits.addEventListener('click', function() {
          click.style.display = 'none';
          credits_content.style.display = 'flex';
        });

      }

      function initCannonWorld() {
        cannon_world = new CANNON.World();
        cannon_world.gravity.set(0, -9.82 * 130, 0);
        cannon_world.broadphase = new CANNON.NaiveBroadphase();
        cannon_world.solver.iterations = 5;

        cannon_plane = new CANNON.Body({
          mass: 0,
          position: new CANNON.Vec3(0, -20, 0),
          shape: new CANNON.Box(new CANNON.Vec3(14000, 10000, 20)),
          material: new CANNON.Material({friction: 0.05, restitution: 0})
        });

        cannon_plane.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI/2)

        plane.userData = cannon_plane;
        cannon_world.add(cannon_plane);
      }

      function initCannonCar(car_model) {
        // var geometry = new THREE.BufferGeometry().setFromPoints(car_model);
        var geometry = new THREE.BoxGeometry(800, 400, 400);
        // geometry.translate(260, 0, -300);
        var material = new THREE.MeshPhongMaterial({ color: 0xffffff });
        carMesh = new THREE.Mesh(geometry, material);
        carMesh.position.set(x_car, y_car, z_car);

        carBody = new CANNON.Body({
          mass: 100,
          position: carMesh.position,
          shape: new CANNON.Box(new CANNON.Vec3(460, 150, 200)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.5})
        });

        carBody.addEventListener("collide", carCollision);

        carMesh.userData = carBody;
        cannon_world.add(carBody);
      }

      function initBarrier() {
        var geometry = new THREE.BoxGeometry(5000, 100, 100);
        var material = new THREE.MeshPhongMaterial({ color: 0xffffff });
        var b_mesh = new THREE.Mesh(geometry, material);

        // ---------------- Centre map barrier 1 ------------------
        var b_mesh0 = b_mesh.clone();
        b_mesh0.rotateY(THREE.MathUtils.degToRad(-67)); // -67 Degrees!
        b_mesh0.position.set(-3850, 0, -3550);

        var b_body = new CANNON.Body({
          mass: 9000,
          position: b_mesh0.position,
          shape: new CANNON.Box(new CANNON.Vec3(2500, 20, 10)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-67));

        b_mesh0.userData = b_body;
        cannon_world.add(b_body);

        barrierMesh.push(b_mesh0);
        barrierBody.push(b_body);

        // ---------------- Centre map barrier 2 ------------------
        var geometry1 = new THREE.BoxGeometry(3500, 100, 100);
        var b_mesh1 = new THREE.Mesh(geometry1, material);

        b_mesh1.rotateY(THREE.MathUtils.degToRad(-31));
        b_mesh1.position.set(-1100, 2, -100);

        var b_body1 = new CANNON.Body({
          mass: 9000,
          position: b_mesh1.position,
          shape: new CANNON.Box(new CANNON.Vec3(1750, 30, 10)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body1.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-31));

        b_mesh1.userData = b_body1;
        cannon_world.add(b_body1);

        barrierMesh.push(b_mesh1);
        barrierBody.push(b_body1);

        // ---------------- Centre map barrier 3 ------------------
        var geometry2 = new THREE.BoxGeometry(4800, 100, 100);
        var b_mesh2 = new THREE.Mesh(geometry2, material);
        b_mesh2.rotateY(THREE.MathUtils.degToRad(-77));
        b_mesh2.position.set(1100, 2, 3500);

        var b_body2 = new CANNON.Body({
          mass: 9000,
          position: b_mesh2.position,
          shape: new CANNON.Box(new CANNON.Vec3(2400, 30, 10)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body2.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-77));

        b_mesh2.userData = b_body2;
        cannon_world.add(b_body2);

        barrierMesh.push(b_mesh2);
        barrierBody.push(b_body2);

        // ---------------- Bottom right barrier ----------------
        var geometry3 = new THREE.BoxGeometry(2800, 100, 100);
        var b_mesh3 = new THREE.Mesh(geometry3, material);
        b_mesh3.rotateY(THREE.MathUtils.degToRad(-87));
        b_mesh3.position.set(8450, 2, 8100);

        var b_body3 = new CANNON.Body({
          mass: 9000,
          position: b_mesh3.position,
          shape: new CANNON.Box(new CANNON.Vec3(1400, 30, 23)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body3.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-87));

        b_mesh3.userData = b_body3;
        cannon_world.add(b_body3);

        barrierMesh.push(b_mesh3);
        barrierBody.push(b_body3);

        // ------------------ Bottom left 1 barrier -----------------------
        var geometry4 = new THREE.BoxGeometry(3800, 100, 100);
        var b_mesh4 = new THREE.Mesh(geometry4, material);
        b_mesh4.rotateY(THREE.MathUtils.degToRad(-74));
        b_mesh4.position.set(-6800, 2, 7500);

        var b_body4 = new CANNON.Body({
          mass: 9000,
          position: b_mesh4.position,
          shape: new CANNON.Box(new CANNON.Vec3(1900, 30, 23)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body4.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-74));

        b_mesh4.userData = b_body4;
        cannon_world.add(b_body4);

        barrierMesh.push(b_mesh4);
        barrierBody.push(b_body4);

        // ------------------ Bottom left 2 barrier -----------------------
        var geometry5 = new THREE.BoxGeometry(2600, 100, 100);
        var b_mesh5 = new THREE.Mesh(geometry5, material);
        b_mesh5.rotateY(THREE.MathUtils.degToRad(90));
        b_mesh5.position.set(-9700, 2, 3000);

        var b_body5 = new CANNON.Body({
          mass: 9000,
          position: b_mesh5.position,
          shape: new CANNON.Box(new CANNON.Vec3(1300, 30, 23)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body5.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(90));

        b_mesh5.userData = b_body5;
        cannon_world.add(b_body5);

        barrierMesh.push(b_mesh5);
        barrierBody.push(b_body5);

        // ---------------- Top left barrier ----------------
        var geometry6 = new THREE.BoxGeometry(6000, 100, 100);
        var b_mesh6 = new THREE.Mesh(geometry6, material);
        b_mesh6.rotateY(THREE.MathUtils.degToRad(10));
        b_mesh6.position.set(-10000, 2, -2150);

        var b_body6 = new CANNON.Body({
          mass: 9000,
          position: b_mesh6.position,
          shape: new CANNON.Box(new CANNON.Vec3(3000, 30, 10)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body6.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(10));

        b_mesh6.userData = b_body6;
        cannon_world.add(b_body6);

        barrierMesh.push(b_mesh6);
        barrierBody.push(b_body6);

        // ---------------- Centre right 1 barrier ----------------
        var geometry7 = new THREE.BoxGeometry(4200, 100, 100);
        var b_mesh7 = new THREE.Mesh(geometry7, material);
        b_mesh7.rotateY(THREE.MathUtils.degToRad(-67));
        b_mesh7.position.set(3000, 2, 650);

        var b_body7 = new CANNON.Body({
          mass: 9000,
          position: b_mesh7.position,
          shape: new CANNON.Box(new CANNON.Vec3(2100, 30, 10)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body7.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-67));

        b_mesh7.userData = b_body7;
        cannon_world.add(b_body7);

        barrierMesh.push(b_mesh7);
        barrierBody.push(b_body7);

        // ---------------- Centre right 2 barrier ----------------
        var geometry8 = new THREE.BoxGeometry(1700, 100, 100);
        var b_mesh8 = new THREE.Mesh(geometry8, material);
        b_mesh8.rotateY(THREE.MathUtils.degToRad(145));
        b_mesh8.position.set(700, 1, -2500);

        var b_body8 = new CANNON.Body({
          mass: 9000,
          position: b_mesh8.position,
          shape: new CANNON.Box(new CANNON.Vec3(1700, 30, 30)),
          material: new CANNON.Material({friction: 0.1, restitution: 0.1})
        });

        b_body8.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(145));

        b_mesh8.userData = b_body8;
        cannon_world.add(b_body8);

        barrierMesh.push(b_mesh8);
        barrierBody.push(b_body8);
      } 

      function initTyres() {
        var geometry = new THREE.BoxGeometry(1400, 300, 300);
        var material = new THREE.MeshPhongMaterial({ color: 0xffffff });
        var t_mesh = new THREE.Mesh(geometry, material);

        // ---------------- Top row of tyres ----------------
        for(var i = 1000; i <= 17900; i+= 1300) {
          var t_clone = t_mesh.clone();
          t_clone.rotateY(THREE.MathUtils.degToRad(4.5)); // -67 Degrees!
          t_clone.position.set(-10000 + i, 200, -6050);

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(4.5));


          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }

        // ---------------- Bottom row of tyres ----------------
        for(var i = 1000; i <= 8500; i+= 1500) {
          var t_clone = t_mesh.clone();
          t_clone.position.set(-4000 + i, 200, 6100);

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }

        // ---------------- Centre right 1 row of tyres ----------------
        for(var i = 1000; i <= 3600; i+= 1300) {
          var t_clone = t_mesh.clone();
          t_clone.position.set(8500 + i, 200, -500);

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }

        // ---------------- Centre right 2 row of tyres ----------------
        var z_increment = 0;
        for(var i = 1000; i <= 2000; i+= 1000) {
          var t_clone = t_mesh.clone();
          t_clone.rotateY(THREE.MathUtils.degToRad(-40));
          t_clone.position.set(5500 + i, 200, -2600 + z_increment);
          z_increment += 900;

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(-40));

          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }

        // ---------------- Centre right 3 row of tyres ----------------
        z_increment = 0;
        for(var i = 1000; i <= 2200; i+= 1200) {
          var t_clone = t_mesh.clone();
          t_clone.rotateY(THREE.MathUtils.degToRad(40));
          t_clone.position.set(2100 + i, 200, -1900 - z_increment);
          z_increment += 900;

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(40));

          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }

        // ---------------- Centre right 4 row of tyres ----------------
        z_increment = 0
        for(var i = 1000; i <= 2200; i+= 1200) {
          var t_clone = t_mesh.clone();
          t_clone.rotateY(THREE.MathUtils.degToRad(133));
          t_clone.position.set(5000 + i, 200, 500 + z_increment);
          z_increment += 1700;

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(133));

          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }

        // ---------------- Centre left row of tyres ----------------
        z_increment = 0;
        for(var i = 1000; i <= 2200; i+= 600) {
          var t_clone = t_mesh.clone();
          t_clone.rotateY(THREE.MathUtils.degToRad(121)); // -67 Degrees!
          t_clone.position.set(-6200 + i, 200, -800 + z_increment);
          z_increment += 900;

          var t_body = new CANNON.Body({
            mass: 5000,
            position: t_clone.position,
            shape: new CANNON.Box(new CANNON.Vec3(650, 150, 150)),
            material: new CANNON.Material({friction: 0.1, restitution: 1})
          });

          t_body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0), THREE.MathUtils.degToRad(121));

          t_clone.userData = t_body;
          cannon_world.add(t_body);

          tyreMesh.push(t_clone);
          tyreBody.push(t_body);
        }
      }

      function initCannonDebugger() {
        cannonDebug = new THREE.CannonDebugRenderer(scene, cannon_world);
      }

      function getAudioContext() {
        AudioContext = window.AudioContext || window.webkitAudioContext ;
        audioContext = new AudioContext();
        audioContext.resume()
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        camera.left = camera.aspect / -2;
        camera.right = camera.aspect / 2;
        renderer.setSize( window.innerWidth, window.innerHeight );
      }

      function carCollision(e) {
        if(e.body.id != 0) {
          increment = -20;
        }
      }
    </script>
</body>
</html>